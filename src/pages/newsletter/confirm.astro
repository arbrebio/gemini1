---
import Layout from '../../layouts/Layout.astro';

const token = Astro.url.searchParams.get('token');
---

<Layout
  title="Confirm Newsletter Subscription"
  description="Confirm your subscription to Arbre Bio Africa's newsletter"
  noIndex={true}
>
  <div class="min-h-screen bg-gray-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8 bg-white p-8 rounded-lg shadow-lg">
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">Confirming Your Subscription</h1>
        <p class="text-gray-600" id="status-message">Please wait while we confirm your subscription...</p>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ token }}>
  async function confirmSubscription() {
    try {
      const response = await fetch(`/api/newsletter/confirm?token=${token}`);
      const statusMessage = document.getElementById('status-message');
      
      if (response.ok) {
        try {
          const result = await response.json();
          if (statusMessage && result) {
            statusMessage.textContent = result.message || 'Your subscription has been confirmed! You can close this window.';
            statusMessage.className = 'text-green-600';
          }
        } catch (jsonError) {
          if (statusMessage) {
            statusMessage.textContent = 'Your subscription has been confirmed! You can close this window.';
            statusMessage.className = 'text-green-600';
          }
        }
      } else {
        try {
          const errorResult = await response.json();
          if (statusMessage && errorResult) {
            statusMessage.textContent = errorResult.message || 'An error occurred while confirming your subscription.';
            statusMessage.className = 'text-red-600';
          }
        } catch (jsonError) {
          if (statusMessage) {
            statusMessage.textContent = 'An error occurred while confirming your subscription.';
            statusMessage.className = 'text-red-600';
          }
        }
      }
    } catch (error) {
      const statusMessage = document.getElementById('status-message');
      if (statusMessage) {
        statusMessage.textContent = 'An error occurred. Please try again later.';
        statusMessage.className = 'text-red-600';
      }
    }
  }

  if (token) {
    confirmSubscription();
  }
</script>